{% for host in virtualhosts %}
    <VirtualHost *:80>
        {% include 'config-based-virtual-host.twig' %}

        RewriteEngine On
        RewriteCond %{HTTPS} !=on
        RewriteRule (.*) https://{{ host.vhost }}$1 [R,L]
    </VirtualHost>
    <VirtualHost *:443>
        {% include 'config-based-virtual-host.twig' %}

        SSLEngine On
        SSLCertificateFile    /etc/ssl/certs/{{ host.vhost }}.crt
        SSLCertificateKeyFile /etc/ssl/private/{{ host.vhost }}.key
        SSLCertificateChainFile    /etc/ssl/certs/{{ host.vhost }}_chain.crt
    </VirtualHost>
{% endfor %}
{% for host in defaulthosts %}
    <VirtualHost *:80>
        {% include 'config-based-virtual-host.twig' %}

        SSLEngine Off
        RewriteEngine On
        RewriteRule (.*) https://{{ host.domain }}$1 [R,L]
    </VirtualHost>
    <VirtualHost *:443>
        {% include 'config-based-virtual-host.twig' %}

        SSLEngine On
        RewriteEngine On
        RewriteCond %{HTTP_HOST} -ne "{{ host.domain }}"
        RewriteRule (.*) https://{{ host.domain }}$1 [R,L]
        SSLEngine On
        SSLCertificateFile    /etc/ssl/certs/{{ host.domain }}.crt
        SSLCertificateKeyFile /etc/ssl/private/{{ host.domain }}.key
        SSLCertificateChainFile    /etc/ssl/certs/{{ host.domain }}_chain.crt
    </VirtualHost>
{% endfor %}